  - name: load etcd settings
    include_vars: '../properties/etcd_cluster_properties.yml'

  - name: Initialize the etcd cluster var
    set_fact:
      etcd_initial_cluster: ''

  - name: Create the etcd cluster var
    set_fact:
      etcd_initial_cluster: "{{ etcd_initial_cluster }},{{ hostvars[groups['etcd'][item | int]]['ansible_default_ipv4']['address'] }}={{ etcd_url_scheme }}://{{ hostvars[groups['etcd'][item | int]]['ansible_default_ipv4']['address'] }}:{{ etcd_peer_port }}"
    with_items: "{{ lookup('sequence','start=0 end='+((groups['etcd'] | count) -1) |string,wantlist=True) }}"
  

  - name: run etcd binary
    shell: >
      nohup /usr/bin/etcd --name {{ etcd_name }} --initial-advertise-peer-urls http://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:23800
      --listen-peer-urls http://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:23800
      --listen-client-urls http://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:23790,http://127.0.0.1:23790
      --advertise-client-urls http://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:23790
      --initial-cluster-token {{ etcd_initial_cluster_token }}
      --initial-cluster {{ etcd_initial_cluster[1:] }}
      --initial-cluster-state {{ etcd_initial_cluster_state }} &

